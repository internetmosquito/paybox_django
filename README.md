# paybox_django

A fork from https://github.com/pmhoudry/pythonPaybox that extends that class with a full Django application so 
PayBox workflow can be easily tested

## Requirements

* Python 2.7
* Install the requirements.txt file 

`pip install -r requirements.txt`

* You will need ngrok to simulate callback URL when running this locally, get it [here](https://ngrok.com/download)

## Getting Started

You will need to do several things first before testing.

* Create database, or you can use the provided one db.sqlite3

`python manage.py migrate`

* Use Django command to generate new orders

`python manage.py generate_orders <number of orders>`

* Start ngrok to create real URL on Django listening port

`./ngrok http 8000`

* Copy the provided URL from ngrok to variable BASE_URL in file payboxtest/paybox/local_settings.py, for instance

`BASE_URL = 'http://22566bf6.ngrok.io/'`

* Change the following values in payboxtest/paybox/local_settings.py with your pre-production crendetials, production ones or [testing ones from Paybox] (http://www1.paybox.com/espace-integrateur-documentation/comptes-de-tests-2/?lang=en) 

`SECRETKEYPROD = '' -> Only if you plan to use production values`
`SECRETKEYTEST = '' -> Either own test SECRET KEY or the one from Paybox, you'll need to login to back-office to obtain this key with testing credentials`
`PBX_SITE = '' -> Seven digits number`
`PBX_IDENTIFIANT = '' -> Nine digits number`
`PBX_RANG = '' -> Two digits number`

* Ready to fire up the server

`python manage.py runserver`

* Either visit localhost:8000 or the URL provided by ngrok

* You'll be confronted with a list of orders, clicking in the UUID of one of the orders will take you to the view that has the embedded form to send the request to PayBox for a Payment. 

* Clicking "Proceed to payment" button will send the request and show the PayBox payment selection view.

* You can select any payment method from there, and use testing (if testing) [cards from PayBox](http://www1.paybox.com/espace-integrateur-documentation/les-cartes-de-test/?lang=en).
 
* Once you enter payment data, click on Valider and you'll be confronted with Receipt PayBox page, where you can click to return to our site.
 
* If everything goes well, you'll see a success page saying Congratulations. Otherwise you'll see an error page.


# How this works

When sending the request form, we use the provided Transaction class, use the 

`post_to_paybox`

Method to sign the request to be sent to Paybox and generate the HMAC key to be sent along the request. The HMAC is based on this signature, 
a combination of mandatory paramenters, optional for PayBox.

Along the optional data we pass several parameters, specially important one are:

* PBX_REFUSE: The URL to be called if there is an error, will be /error_response in our case
* PBX_REPONDRE_A: This is the IPN (Instant Payment Notification URL), deals with the response from PayBox no matter what the customer did, it is important since will update order status. In our case this URL will be /manage_response
* PBX_EFFECTUE: The URL to be called when everything goes well and customer wants to return to our site, in our case /success
* PBX_ANNULE: The URL to be called if purchase in canceled, will be /error_response in our case


The mandatory parameters to be sent are:

* PBX_SITE -> Defined in local_settings.py
* PBX_RANG -> Defined in local_settings.py
* PBX_IDENTIFIANT -> Defined in local_settings.py
* PBX_TOTAL -> Obtained from order.total_incl_tax and converted to cents
* PBX_DEVISE -> (number, 978 for â‚¬)
* PBX_PORTEUR -> Obtained from order.customer.email
* PBX_RETOUR -> (list of variables that paybox will return with the payment confirmation)
* PBX_HASH -> (How you've keyed-hashed your message. SHA512 in this app)
* PBX_TIME -> Obtainer from order.created_date (ISO 8601 Format)
* PBX_HMAC -> Generated by Transaction.post_to_paybox


When /manage_payment is called, we verify the request provided to make sure it comes from PayBox, using the method

`verify_notification`

That will check that incoming request is signed correctly from PayBox and amount matches the one sent in the first request.

If everything goes well, order status changes from PENDING to PAID afterwards.

All the pages from Paybox - Payment method selection, payment data input, receipt, are customizable, but we're using default ones here.


# TODO

* Add form to create order from main page
* Add Docker file to run this in a container
* Testing